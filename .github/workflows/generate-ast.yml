name: Generate AST Classes

on:
  push:
    paths:
      - 'grammar/**'
      - 'tools/AstGenerator.java'
      - '.github/workflows/generate-ast.yml'
    branches: [main]

permissions:
  contents: write

jobs:
  generate-ast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed for git rebase/push

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Ensure AST output directory exists
        run: mkdir -p src/danex/ast

      - name: Download ANTLR runtime if not already present
        run: |
          mkdir -p lib
          if [ ! -f lib/antlr-4.9.2-complete.jar ]; then
            echo "Downloading ANTLR runtime..."
            curl -L -o lib/antlr-4.9.2-complete.jar https://www.antlr.org/download/antlr-4.9.2-complete.jar
          else
            echo "ANTLR JAR already exists."
          fi

      - name: Ensure parser JAR exists
        run: |
          if [ ! -f lib/danex-parser.jar ]; then
            echo "‚ùå lib/danex-parser.jar not found. Ensure your parser build workflow runs first."
            exit 1
          fi

      - name: Compile AstGenerator
        run: |
          mkdir -p bin
          javac -cp "lib/danex-parser.jar:lib/antlr-4.9.2-complete.jar" -d bin tools/AstGenerator.java

      - name: Run AstGenerator
        run: |
          java -cp "bin:lib/danex-parser.jar:lib/antlr-4.9.2-complete.jar" tools.AstGenerator

      - name: Show generated AST files
        run: |
          echo "Generated AST files under src/danex/ast:"
          find src/danex/ast -maxdepth 1 -name "*.java" -printf "  %f\n"

      - name: Commit generated AST classes if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin main
          git rebase origin/main

          git add src/danex/ast
          if git diff --cached --quiet; then
            echo "No AST changes to commit."
          else
            git commit -m "chore: regenerate AST classes [skip ci]"
            git push origin HEAD:main
          fi
